-- MySQL Script generated by MySQL Workbench
-- Wed Mar 15 17:27:58 2017
-- Model: New Model    Version: 1.0
-- MySQL Workbench Forward Engineering

SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0;
SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0;
SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='TRADITIONAL,ALLOW_INVALID_DATES';

-- -----------------------------------------------------
-- Schema mydb
-- -----------------------------------------------------

-- -----------------------------------------------------
-- Schema mydb
-- -----------------------------------------------------
CREATE SCHEMA IF NOT EXISTS `mydb` DEFAULT CHARACTER SET utf8 ;
USE `mydb` ;

-- -----------------------------------------------------
-- Table `mydb`.`Instructors`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `mydb`.`Instructors` (
  `idInstructors` INT NOT NULL,
  `InstrFName` VARCHAR(45) NULL,
  `InstrLName` VARCHAR(45) NULL,
  `InstrUserN` VARCHAR(45) NULL,
  `InstrPassW` VARCHAR(45) NOT NULL,
  PRIMARY KEY (`idInstructors`))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mydb`.`Courses`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `mydb`.`Courses` (
  `idCourses` INT NOT NULL,
  `CourseName` VARCHAR(45) NULL,
  `StuFName` VARCHAR(45) NULL,
  `StuLName` VARCHAR(45) NULL,
  `Coursescol` VARCHAR(45) NULL,
  `Instructors_idInstructors` INT NOT NULL,
  PRIMARY KEY (`idCourses`, `Instructors_idInstructors`),
  INDEX `fk_Courses_Instructors1_idx` (`Instructors_idInstructors` ASC),
  CONSTRAINT `fk_Courses_Instructors1`
    FOREIGN KEY (`Instructors_idInstructors`)
    REFERENCES `mydb`.`Instructors` (`idInstructors`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mydb`.`Students`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `mydb`.`Students` (
  `idStudents` INT NOT NULL,
  `StuFName` VARCHAR(45) NULL,
  `StuLName` VARCHAR(45) NULL,
  `StuUserN` VARCHAR(45) NULL,
  `StuPassW` VARCHAR(45) NULL,
  `GPA` INT NULL COMMENT 'this is a derived attribute that makes a calculation based off all class averages of that student',
  PRIMARY KEY (`idStudents`))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mydb`.`Courses_has_Students`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `mydb`.`Courses_has_Students` (
  `Courses_idCourses` INT NOT NULL,
  `Students_idStudents` INT NOT NULL,
  PRIMARY KEY (`Courses_idCourses`, `Students_idStudents`),
  INDEX `fk_Courses_has_Students_Students1_idx` (`Students_idStudents` ASC),
  INDEX `fk_Courses_has_Students_Courses_idx` (`Courses_idCourses` ASC),
  CONSTRAINT `fk_Courses_has_Students_Courses`
    FOREIGN KEY (`Courses_idCourses`)
    REFERENCES `mydb`.`Courses` (`idCourses`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_Courses_has_Students_Students1`
    FOREIGN KEY (`Students_idStudents`)
    REFERENCES `mydb`.`Students` (`idStudents`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mydb`.`Admins`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `mydb`.`Admins` (
  `idAdmins` INT NOT NULL,
  `AdmUserN` VARCHAR(45) NULL,
  `AdmPassW` VARCHAR(45) NULL,
  PRIMARY KEY (`idAdmins`))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mydb`.`Grades`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `mydb`.`Grades` (
  `TestNum` INT NULL,
  `Score` INT NULL,
  `Courses_has_Students_Courses_idCourses` INT NOT NULL,
  `Courses_has_Students_Students_idStudents` INT NOT NULL,
  INDEX `fk_Grades_Courses_has_Students1_idx` (`Courses_has_Students_Courses_idCourses` ASC, `Courses_has_Students_Students_idStudents` ASC),
  CONSTRAINT `fk_Grades_Courses_has_Students1`
    FOREIGN KEY (`Courses_has_Students_Courses_idCourses` , `Courses_has_Students_Students_idStudents`)
    REFERENCES `mydb`.`Courses_has_Students` (`Courses_idCourses` , `Students_idStudents`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mydb`.`averages`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `mydb`.`averages` (
  `Courses_has_Students_Students_idStudents` INT NOT NULL,
  `Courses_has_Students_Courses_idCourses` INT NOT NULL,
  `totalScore` INT NULL,
  `courseAVG` INT NULL,
  INDEX `fk_averages_Courses_has_Students1_idx` (`Courses_has_Students_Courses_idCourses` ASC, `Courses_has_Students_Students_idStudents` ASC),
  PRIMARY KEY (`Courses_has_Students_Students_idStudents`),
  CONSTRAINT `fk_averages_Courses_has_Students1`
    FOREIGN KEY (`Courses_has_Students_Courses_idCourses` , `Courses_has_Students_Students_idStudents`)
    REFERENCES `mydb`.`Courses_has_Students` (`Courses_idCourses` , `Students_idStudents`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;

USE `mydb`;

DELIMITER $$
USE `mydb`$$
CREATE DEFINER = CURRENT_USER TRIGGER `mydb`.`Grades_BEFORE_INSERT` BEFORE INSERT ON `Grades` FOR EACH ROW
BEGIN
	DECLARE num_row integer;
    DECLARE tot_rows integer;
    
SELECT COUNT(*)
	INTO tot_rows
    FROM Grades
    WHERE Courses_has_Students_Courses_idCourses=NEW.Courses_has_Students_Courses_idCourses AND
		Courses_has_Students_Students_idStudents=NEW.Courses_has_Students_Students_idStudents;
		
    SELECT COUNT(*)
	INTO num_row
    FROM averages
    WHERE Courses_has_Students_Courses_idCourses=NEW.Courses_has_Students_Courses_idCourses AND
		Courses_has_Students_Students_idStudents=NEW.Courses_has_Students_Students_idStudents;   
    
    IF num_row > 0 THEN
		UPDATE averages
        SET totalScore = New.Score + totalScore,
			courseAVG = totalScore/(tot_rows+1)
			WHERE Courses_has_Students_Courses_idCourses=NEW.Courses_has_Students_Courses_idCourses AND
				Courses_has_Students_Students_idStudents=NEW.Courses_has_Students_Students_idStudents;   

	ELSE
    INSERT INTO averages
		(Courses_has_Students_Students_idStudents, Courses_has_Students_Courses_idCourses, totalScore, courseAVG)
        VALUES 	(NEW.Courses_has_Students_Students_idStudents, NEW.Courses_has_Students_Courses_idCourses, new.Score, new.Score);
	
    END IF;

		
END$$


DELIMITER ;
CREATE USER 'user1';


SET SQL_MODE=@OLD_SQL_MODE;
SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS;
SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS;
